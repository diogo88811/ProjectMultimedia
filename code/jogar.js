"use strict";


(function()
{	
	window.addEventListener("load", main);
}());


var i = 0;
function main(){

    var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext("2d");
	canvas.addEventListener("initend", initEndHandler);
	window.addEventListener("message", messageHandler);
	var main;
	var player = new Jogador("nome", 0);
	var johny;
	var motorjogo;
	var level = new Array(3);
	
	/* 										 CONSTRUÇÃO DO MAPA

							# [Plataformas]						C [Moedas]
							* [Terra]							E [Enimgos Normais]
							- [Superficie]						L [Enimigos Rapidos]
							A [Plataformas moveis]  			S [Enimigos Saltam]
	*/
	var mapa1 = new Array("                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ",
						"                                                                                                                                                                                                                                                  C                                                                                                                                                                                                                                                                                                                        ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ",
						"                                                                                                                                                                                                       C     C                                   ---         ---                                                                                                                           ##           ##  ###  #    #                                                                                                                                                    ",
						"                                                                                                                                                                                        C                                                        ***         ***                                                                                                                             #    #    #    #    #    #                                                                                                                                                    ",
						"                                                                                                                                                                                        -             #########                                  *** S       ***                                                                                                                             #   # #   #    ##   #    #                                                                                                                                                    ",
						"                                                                                                                                                                                                                                                 ***         ***                                                                                                                              # #   # #     #    #    #                                                                                                                                                    ",
						"                                                                                                                                                                                                                                                 ***         ***                                                                                                                               #     #      ###  ###  ###                                                                                                                                       ###########*",
						"                                                                                            -  E              -                                                                  C            C                                                  ***         ***                       C                                                                                                                                                                                                                                                                                   *",
						"                                                                                            *                 *                                                                                                                                  ***--       ***                                                                                                                                                                                                                                                                                                           *",
						"                                                     C                                      *                 *                                                                  -            -                      A                           *****    S  ***                       -                                                                                                       ####     ####   ##   #  ###                                                                                                                                         F       *",
					 	"                                                                                            *                 *                                                                                                              A                               ***                C             C                                                                                                #   #   #    #  # #  #  #                                                                                                                                                   *",
					 	"                                                     -         S                           ####################                                                                                                                                              ***                                                                                             ------------                      #   #   #    #  #  # #  ##                                                                                                                                                  *",
						"                                                                                                                                                                                       C                                                                     ***                -             -                                                 -------------************                      ####     ####   #   ##  #                                                                                                                S                                  *",
						"                                                 S                           C C C                                                                                                                                                                         --***                                                                   C                    *****************                                              ###                                                                                                                                                 *",
						"                                                                                                                                                                                       -                                                                   *****          C                          C                                                  *****************                                                                                                                                           S                                                      *",
						"                                                               -            ###########                               -                                                                                                                                    *****                                                                ##########              *****************                                                                                                                                                                                -------------------",
						"                                                                                                                                    S                  S                                                                                                   *****          -                          -                                                  *****************                                                                                                                                                                      ----------*******************",
						"                                                 -       C                                                                  -                                                                 C                                      A                     *****                                                                                        *********                                                                                                                               S                                   -----------*****************************",
						"                                                                                                                                                                                                                                                  C      --*****                                              ###########                               *********                                                                                                                                                         ----------****************************************",
						"                                                         -                                                                                                                                    -                                                          *******                                              *                                                                                                                                                            S                                    ----------**************************************************",
						"                      -  E                -                            -  E               -                                         -   E               -           E       L                                                                    ---       *****                                              *                                                                                                      L                                                                                ----------************************************************************",
						"                      *                   *                            *                  *                                         *                   *                                                                                        ***       *****                                              *                            C C C C C C  C C C C C                                                                                                                           ----------**********************************************************************",
						"                      *                   *                            *                  *                                         *                   *                                                                                        ***       *****                                              *                            C C C C C C  C C C C C                                      -                                                                         ----------*********************************************************************************",
						"                      *                   *                            *                  *                                         *                   *                                                                                        ***       *****                                              *                            C C C C C C  C C C C C                                      *                                                               ----------*******************************************************************************************",
						"----------------------*-------------------*                            *------------------*                                         *-------------------*-------------------------------------------------                             ----------***       *****                                              *----------------            ----------------------------        -        -      -       *---------------------------------------------------------------*****************************************************************************************************",
						"*******************************************                            ********************                                         **********************************************************************                             *************       *****                                              *****************            ****************************        *        *      *       *********************************************************************************************************************************************************************",
						"*******************************************                            ********************                                         **********************************************************************                             *************       *****                                              *****************            ****************************        *        *      *       *********************************************************************************************************************************************************************",
						);



	var mapa = new Array("                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ",
						"                                                                                                                    --------------------------------------------------                                -----------------                                                                                                                                                                                                                                                                                                                                       ",      
						"                                                                                                                    **************************************************                                *****************                                                                                                                                 C                                                                                                                                                                                                     ",
						"                                                                                                                    *********                         ****************                                *****************                                                                                                                                                                                                                                                                                                                                       ",
						"                                                                                                                    *********  C  C  C                ****************                                *****************                                                                                                                                                                                                                                                                                                                                       ",
						"                                                                                                                    *********                         ****************                                *****************                                                                                        -----------                              -                                                                                                                                                                                                     ",
						"                                                                                                                    *********  C  C  C                                                                                                                                                                         ***********                              *                                      C                                                                                                                                                              ",
						"                                                                                                                    *********                                                                                                                                                                                  ***********                       C      *                                                                       C                                                                                                                             ",
						"                                                                                  C                                 *********###########                                                                                                                                                                       ***********                              *                   C                 ###                                                                                                                                                             ",
						"                                                                                                                    *********                         C  C  C  C  C  C                                                                                                                                         ***********                C      -      *       S                                                              ###                                                                                                                            ",
						"                                                                                                                    *********                                                                                                   ############                S                                                  ***********                       *      *                  ###                                                                                                                                                                                ",
						"                                                                                                                                                      C  C  C  C  C  C                                                                                                                                         ***********                       *      *                                                                                                                                                                      C                              ", 
						"                                                                                                                                                                                                                                                                                                                                   C      -      *      *                            S                         C                                                                                                                                      F       ", 
						"                                                                                                                                        #             C  C  C  C  C  C                                                                                                                                                                    *      *      *       ##                                     S                                                                                        S          ##############                                     ", 
						"                                                      #########                                                                                                                     C                -----------------                                ##############                                                                      *      *      *                                  --------           ###      S                                                                                                               C                      ",
						"                                                                          C                C                                                         -----------------                            S  *****************                                                   E                                                         -      *      *      *                                  ********                          --------                                                                                                                         ",
						"                                                                                                                                                     *****************                               *****************                                                                                                             *      *      *      *                --------    #     ********                          ********                                                                                                                         ",
						"                                      #########                                                                     ---------               ----     *****************           ########            *****************       ###                                                                                                   *      *      *      *                ********          ********    #                     ********                                                        ########                                     C                   ",
						"                                                                          -       A        -               S        *********               ****     *****************                               *****************                                                                                         -------------       *      *      *      *                ********          ********                    #     ********                                                                                                                 #       ",
						"                      S                                                                                             *********               ****     *****************                           ####*****************                                                   ##############                        ***********         *      *      *      *                ********          ********         --------         ********            C  C  C  C  C  C                                                                                             ",                          
						"                                                                                                                    *********               ****     *****************                               *****************                                                                                         ***********         *      *      *      *                ********          ********         ********         ********                                          ######                                                       C                 ",
						"                                                                                                                    *********           ###          *****************                               *****************  C                                                                      C    C   C      ***********         *      *      *      *                ********          ********         ********         ********            C  C  C  C  C  C                                                                                             ",
						"                                                                                                                    *********                        *****************                               *****************                                                                                         ***********         *      *      *      *                ********          ********         ********         ********                                                                                                      ####               ",
						"-----------------------------------------------------------------                                     --------------*********------------------------*****************--------                       ----------------------                                                                    ##############  ***********         *      *      *      *       -----------------          --------         --------         ------------------------------------------------                                                                                 ",
						"*****************************************************************                                     ************************************************************************                       **********************                                                                                    ***********         *      *      *      *       *****************          ********         ********         ************************************************                                                    ###                          ",
						"*****************************************************************                                     ************************************************************************                       **********************                                                                                    ***********         *      *      *      *       *****************          ********         ********         ************************************************                                                                                 ",
						);



	var mapa2 = new Array("                                                                                                                                                                                                                                                                                                                                                                                                                            #                                                                                                                            ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                             #                                                                                                                             ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                             #                                                                                                                             ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                             #                                                                                                                             ",
						"                                                                                                                                                                                                                                                                                                                                                                                                                             #                                                                                                                             ",
						"                                                                                                                                                                                                                                                                                                                                                 ########    #################################################################                                                                                                                             ",
						"                                                                                                                                                                                                                                                                                                                                                 ########    #################################################################                                                                                                                             ",
						"                                                                                                                                                                                                                                                                                                                                                 ########    #################################################################                                                                                                                             ",
						"                                                                                                                                                                                                                                                                                   A                                                             ########    #################################################################                                                                                                                             ",
						"                                                                                                                                                     ###########           ######                                                                                         A                                                                      ########    #################################################################                                                                                                                             ",
						"                                                                                                                                                     *                                                                                                                                                                                           #######                                                               #######                                                                                                                             ",
						"                                                                                                                                                     *                                                                                                                                                                                           #######                                   C C C C C C C C C C C C C   #######                                                                                                                             ",
						"                                                                                                                                                     *                                                                                                             A                                                                         A   #######                                                               #######                                                                                                                             ",
						"               -------                                                                                                                               *                                                                                                                                          C                                                #######                                   C C C C C C C C C C C C C         #                                                                                                                             ",
						"               *******                                                                                                                               *                                                                                                                                                                                           #######                                                                     #                                                                                                                             ",
						"               *******                                                                                                                               *                                                                                                       A                                                                                   #######                                   C C C C C C C C C C C C C         #                                                                                                                             ",
						"               *******                                                                                                                            A  *                                                                                                                                                                                           #######                                                                     #                          #                                                                                                  ",
						"                                                                                                                                                     *                                                                                                   A                                          C                                            ######                                    C C C C C C C C C C C C C         #                                      S                                                                                      ",
						"                                                                                            S                 S                                      *                                                                                                                                                                                           ###################      #########      ########        #####################                                                                                                                             ",
						"                                                                                                                                                     *                                                                                                                                                                                           ########              #              #                                                                                                                                                                    ",
						"                        S                                                S                                                                           *                                                                                                                                                                                 A         #######                                                                                                            #                                                                                      ",
						"                                                                                            -                  -                                     *                                                                                            A                                                   C                                          #######                                                                                                                                                                                              F    ",
						"                                         #         #        #                               -                  -                              A      *                                                                                                                                                                                                                                                                                           A                                                                                                         ",
						"                                 #       *         *        *                E              - E                -  L                                  *       E             S           S            S              S              S                                                                                L                                    L                        E       L          L             E            S                                                                                 S                   L                     ",
						"         ########    #######     *       *         *        *          #####                -                  -            S         S              *                                                                                                                                                                                                                                                                                                                       C C C C C C C C C C C C C C       C C C C C C C C C                           ",
						"         ********    *******     *       *         *        *          *****                -                  -                                     *                                                                                                                                                                                                                                                                                                                       C C C C C C C C C C C C C C       C C C C C C C C C                           ",
						"         ********    *******     *       *         *        *          *****                -                  -                                     *                                                                                                                                                                                                                                                                                                                       C C C C C C C C C C C C C C       C C C C C C C C C                           ",
						"---------********    *******     *       *         *        *          ------------------------------------------------------------------------------*-----------------------------------------------------------------------------------------                                                     -----------------------------------------------------------------------------------------------------------------------------------------------                        --------------------------------------------------------------------------------",
						"*****************    *******     *       *         *        *          ************************************************************************************************************************************************************************                                                     ***********************************************************************************************************************************************                        ********************************************************************************",
						"*****************    *******     *       *         *        *          ************************************************************************************************************************************************************************                                                     ***********************************************************************************************************************************************                        ********************************************************************************",
						);

	motorjogo = new MotorJogo(player);
	motorjogo.init(ctx);


    function initEndHandler(ev){

        addEventListener("keydown",kh);
		addEventListener("keyup",kh);

		johny = new MainChar(20,450,50,90,ev.johnyArray[0], ev.bullet, ev.johnyArray, ev.johnyIdleArray, ev.johnyIdleInv, ev.johnyInvArray, ev.gameSounds);
		level[0] = new Nivel(ev.background[0], ev.coin, ev.platArray, mapa,johny, ev.enemy, ev.heart, ev.pauseIcons, ev.enemyInv, ev.star, ev.fireCount);
		level[1] = new Nivel(ev.background[1], ev.coin, ev.platArray, mapa1,johny, ev.enemy, ev.heart, ev.pauseIcons, ev.enemyInv, ev.star, ev.fireCount);
		level[2] = new Nivel(ev.background[2], ev.coin, ev.platArray, mapa2,johny, ev.enemy, ev.heart, ev.pauseIcons, ev.enemyInv, ev.star, ev.fireCount);
		ctx.canvas.addEventListener("click", cch);

		level[0].initialiseMap();
		level[0].drawMap(ctx);
		level[1].initialiseMap();
		level[1].drawMap(ctx);
		level[2].initialiseMap();
		level[2].drawMap(ctx);
		johny.gameSounds[0].play();
        startAnim(ctx, motorjogo, level,johny);
	}
	
	
	
	// Handler para
    var kh = function(ev){	
        motorjogo.canvasKeyHandler(ev, johny);
	}

	// Handler para os clicks no menu pausa
	var cch = function(ev)
	{	
		if(i == 3){
			motorjogo.canvasClickHandler(ev, johny, level[i-1], main);
		}
		else{
			motorjogo.canvasClickHandler(ev, johny, level[i], main);
		}
	}
	
	// Handler para receber mensagens
	function messageHandler(ev){
		main = ev.source;
		player.name = ev.data;
	}
}


//FORA DA MAIN
function startAnim(ctx, motorjogo, level,johny){
	
	animLoop(ctx, motorjogo, level, johny, 0);
}

function animLoop(ctx, motorjogo, level,johny, startTime, time){

	if(i < 3){	
		if(johny.intersectPixelCheck(level[i].flag)){
			johny.x = johny.xIni;
			motorjogo.player.setCoins(johny.coinsCount);
			i++;
		}
	}
	var al = function(time){
		if(startTime == 0){
			startTime = time;
		}
		animLoop(ctx, motorjogo, level,johny,startTime, time);
	}

	var reqID = window.requestAnimationFrame(al);
	if(i == 3){	
		motorjogo.render(ctx, reqID, level[i-1], johny, time,true);
	}
	else{
		motorjogo.render(ctx, reqID, level[i], johny, time,false);
	}
	
}